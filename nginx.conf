# GDPR: Map per anonimizzare l'IP (azzera ultimo ottetto IPv4 / ultima parte IPv6)
map $remote_addr $anonymized_ip {
    default $remote_addr; # Default: non modificare se non matcha i pattern
    ~^(\d+\.\d+\.\d+)\.    $1.0; # IPv4
    ~^([0-9a-fA-F:]+):[0-9a-fA-F:]+$ $1:0; # IPv6 (semplificato)
}

# GDPR: Formato di log che usa l'IP anonimizzato e omette X-Forwarded-For originale
log_format gdpr_compliant '$anonymized_ip - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent"';

error_log /dev/stderr notice; # Aggiunto per log pi√π dettagliati

# Server block for HTTP to HTTPS redirection
server {
    listen 80 default_server;
    server_name eduapp.it *.eduapp.it; # Aggiornato con il dominio

    # Redirect all HTTP requests to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Server block for HTTPS
server {
    listen 443 ssl http2 default_server;
    server_name eduapp.it *.eduapp.it; # Aggiornato con il dominio

    client_max_body_size 50m; # Aumenta limite upload a 50MB

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/eduapp.it_ssl_certificate.cer; # USA IL CERTIFICATO DEL SERVER CORRETTO
    ssl_certificate_key /etc/ssl/private/_.eduapp.it_private_key.key; # Percorso della chiave privata nel container
    # ssl_trusted_certificate /etc/ssl/certs/fullchain.pem; # Opzionale: Potrebbe aiutare Nginx a trovare gli intermedi se necessario

    # Recommended SSL settings (adjust as needed)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers ECDH+AESGCM:ECDH+CHACHA20:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    # Add HSTS header (optional but recommended) - uncomment after testing
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # GDPR: Abilita access log con formato anonimizzato
    access_log /var/log/nginx/access.log gdpr_compliant;

    # Impostazioni comuni per il proxy
    proxy_set_header Host $host;
    # GDPR: Passa l'IP anonimizzato al backend invece di quello reale
    proxy_set_header X-Real-IP $anonymized_ip;
    proxy_set_header X-Forwarded-For $anonymized_ip; # Passa solo l'IP anonimizzato
    # Important: Set X-Forwarded-Proto to https
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;

    # Location per Frontend Studenti
    location /studenti/ {
        proxy_redirect off;
        proxy_pass http://frontend-student:80;
    }
    location = /studenti {
        return 301 /studenti/;
    }

    # Location per Frontend Docenti
    location ^~ /docenti/ {
        add_header X-Debug-Proxy "Reached Docenti Location" always;
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
    }
    location = /docenti {
        return 301 /docenti/;
    }

    # Location per Frontend Lezioni
    location /lezioni/ {
        proxy_redirect off;
        proxy_pass http://frontend-lessons:80;
    }
    location = /lezioni {
        return 301 /lezioni/;
    }

    # Location per l'Admin Django
    location /admin/ {
        proxy_pass http://backend:8000/admin/;
    }

    # Location per le API Backend
    location /api/ {
        proxy_pass http://backend:8000;
    }

    # Location per i file Media
    location /media/ {
        alias /usr/share/nginx/media/;
        expires 1d;
    }

    # Location per i file Statici
    location /static/ {
        alias /usr/share/nginx/static/;
        expires 1d;
    }

    # Location per gli assets
    location /assets/ {
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
    }

    # Root generica - Serve l'index.html statico e altri file nella root
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html =404;
    }

    # Location specifica per la Landing Page
    location /landing {
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
    }

    # Location specifica per la Dashboard
    location /dashboard {
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
    }

    # Esempio location /login/ (se necessario)
    # location /login/ {
    #     proxy_pass http://frontend-lessons:80;
    # }
}