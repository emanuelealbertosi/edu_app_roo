error_log /dev/stderr notice; # Aggiunto per log più dettagliati

server {
    listen 80 default_server;
    server_name 217.154.2.9 _;

    client_max_body_size 50m; # Aumenta limite upload a 50MB

    # Impostazioni comuni per il proxy
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;

    # Location per Frontend Studenti (con rewrite e try_files)
    location /studenti/ {
        proxy_redirect off;
        # Rimosso rewrite e try_files, proxy_pass senza slash finale
        proxy_pass http://frontend-student:80;
    }
    location = /studenti {
        return 301 /studenti/;
    }

    # Location per Frontend Docenti (con rewrite e try_files)
    location ^~ /docenti/ {
        add_header X-Debug-Proxy "Reached Docenti Location" always; # Aggiunto header di debug
        proxy_redirect off;
        # Rimosso rewrite e try_files, proxy_pass senza slash finale
        proxy_pass http://frontend-teacher:80;
    }
    location = /docenti {
        return 301 /docenti/;
    }

    # Location per Frontend Lezioni
    location /lezioni/ {
        proxy_redirect off;
        proxy_pass http://frontend-lessons:80; # Inoltra al servizio frontend-lessons
    }
    location = /lezioni {
        return 301 /lezioni/;
    }

    # Location per l'Admin Django
    location /admin/ {
        proxy_pass http://backend:8000/admin/; # Corretto nome servizio backend a 'backend'
    }

    # Location per le API Backend
    location /api/ {
        proxy_pass http://backend:8000; # Corretto nome servizio backend a 'backend'
    }

    # Location per i file Media
    location /media/ {
        alias /usr/share/nginx/media/;
        expires 1d;
    }

    # Location per i file Statici
    location /static/ {
        alias /usr/share/nginx/static/;
        expires 1d;
    }

    # Location per gli assets (JS, CSS, immagini, ecc.) serviti dalle app frontend
    # Deve venire prima della location / generica
    # Inoltra a frontend-teacher perché LandingView (servita da lì) li richiede da /assets/
    location /assets/ {
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80; # Inoltra a frontend-teacher
        # Potrebbe essere necessario aggiungere expires o altre direttive per il caching
    }

    # Root generica - Serve l'index.html statico e altri file nella root (es. logo.png)
    location / { # Modificato per gestire anche logo.png e potenziali altri file root
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html =404; # Serve file specifici (es. logo.png) o index.html
    }

    # Location specifica per la Landing Page (servita da frontend-teacher)
    location /landing {
        # Questa rotta è gestita dal router interno di frontend-teacher,
        # quindi dobbiamo inoltrare tutto a quell'applicazione.
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
        # Aggiungere qui la gestione di try_files per SPA se necessario
        # (se il container frontend-teacher non lo fa già)
        # try_files $uri $uri/ /index.html;
    }

    # Location specifica per la Dashboard (servita da frontend-teacher)
    location /dashboard {
        proxy_redirect off;
        proxy_pass http://frontend-teacher:80;
    }

    # Aggiungere qui location specifiche per /login/* se si vuole forzare l'instradamento
    # a frontend-lessons invece di lasciarlo catturare da /lezioni/
    # Esempio:
    # location /login/ {
    #     proxy_pass http://frontend-lessons:80;
    # }
}